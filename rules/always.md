# 常に遵守すべきルール

このファイルには、どのような作業においても常に考慮すべき価値観と優先順位を記載します。

## 開発手法

### 仕様書駆動開発 + テスト駆動開発（Spec-Driven + TDD）

このプロジェクトでは以下のサイクルで開発を進める：

1. **仕様書を作成・更新**（`specs/`）
2. **仕様に基づいてテストを作成・更新**
3. **テストが通るように実装**
4. 1に戻る

#### 重要な原則
- 仕様変更時は、まずテストを変更する
- テストが先、実装が後（Red → Green → Refactor）
- テストの実装に時間をかけることを厭わない
- カバレッジ100%を目標とする

## 優先順位（重要度順）

### 1. 仕様書との整合性
- `specs/` ディレクトリの仕様書（全レイヤー）がSource of Truth
- 仕様書は3レイヤー構成: L1（ビジネス）→ L2（機能）→ L3（技術）
- 実装前に必ず仕様書を確認
- 仕様書に記載のない機能は実装しない
- 仕様と実装に齟齬がある場合は、仕様書を正とする
- 不明点があれば実装前に確認する

### 2. テストによる品質担保
- 仕様をテストコードで表現する
- テストが通ることで仕様通りの動作を保証
- カバレッジ100%を維持
- テストなしの実装は原則禁止

### 3. 機能の正確性（バグがないこと）
- 仕様通りに動作することが最優先
- エッジケースを考慮した実装
- 型安全性を活用してバグを防ぐ

### 4. 保守性
- 人間がコードを読む前提で書く
- 適切な抽象化を行う
- 日本語のコメントを適宜入れる
- 複雑なロジックには必ず説明を付ける
- 関数・クラスの責務を明確にする

### 5. セキュリティ
- 入力値は常に検証・サニタイズ
- SQLインジェクション対策（ORM/パラメータ化クエリ使用）
- XSS対策（出力エスケープ）
- 認証・認可の適切な実装
- シークレット情報の適切な管理

### 6. パフォーマンス
- N+1問題を起こさない
- 不要なデータ取得を避ける
- 適切なインデックス設計
- 必要に応じてキャッシュを検討

## 開発スピードについて

- AI駆動開発により十分な速度が出る想定
- スピードのために品質を犠牲にしない
- 上記優先順位を守ることが結果的に速い開発につながる

## 外部参照ルール（AI駆動開発時の必須事項）

汎用的な技術ベストプラクティスはローカルに保持せず、必要に応じて外部参照する。
以下のタイミングで、対応するドキュメントを参照すること。

### Next.js / React 実装時
- **参照タイミング**: コンポーネント設計、データフェッチ、ルーティング実装時
- **参照先**: Next.js公式ドキュメント（https://nextjs.org/docs）をWeb検索またはMCPで取得
- **例**: Server Components vs Client Componentsの使い分け、App Routerの規約

### TypeScript 実装時
- **参照タイミング**: 型設計、ジェネリクス、ユーティリティ型の使用時
- **参照先**: TypeScript公式ドキュメント（https://www.typescriptlang.org/docs）をWeb検索で取得
- **例**: 高度な型パターン、型ガードの書き方

### テスト実装時
- **参照タイミング**: テストの書き方、モック、非同期テストの実装時
- **参照先**: Vitest / React Testing Library / Playwright 公式ドキュメントをWeb検索で取得
- **例**: Testing Libraryのクエリ優先順位、Playwrightのロケーター

### セキュリティ対策時
- **参照タイミング**: 認証・認可、入力検証、脆弱性対策の実装時
- **参照先**: OWASP（https://owasp.org）、Next.js Security GuideをWeb検索で取得
- **例**: XSS対策の具体的手法、CSRFトークンの実装

### アクセシビリティ対応時
- **参照タイミング**: フォーム、モーダル、動的コンテンツのUI実装時
- **参照先**: WCAG 2.2（https://www.w3.org/WAI/WCAG22/quickref/）をWeb検索で取得
- **例**: ARIAの正しい使い方、フォーカス管理

### パフォーマンス最適化時
- **参照タイミング**: 画像最適化、バンドルサイズ削減、Core Web Vitals改善時
- **参照先**: Next.js Production Checklist、Web VitalsをWeb検索で取得
- **例**: Image最適化オプション、動的インポートの使い方

## コミット前チェックリスト

- [ ] 仕様書（`specs/`）との齟齬がないか
- [ ] テストが追加・更新されているか
- [ ] すべてのテストが通るか
- [ ] カバレッジが維持されているか
- [ ] 型エラー・ビルドエラーがないか
- [ ] セキュリティ上の問題がないか

## ルールの継続的改善

人間からのフィードバックに、今後の開発でも一貫して意識すべき指摘が含まれていた場合は、該当するルールファイル（`rules/`配下）を更新してください。

これにより：
- 同じ指摘を繰り返し受けることを防ぐ
- チーム全体でナレッジを共有できる
- AIアシスタントも次回以降同じルールに従える
